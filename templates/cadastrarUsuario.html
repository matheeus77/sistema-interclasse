{% include 'head.html' %}

<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<main class="card-container">
    <!-- LISTA DE USUÁRIOS -->
    <section class="table-section">
        <div class="header-actions">
            <h2>Lista de Usuários</h2>
            <button id="openModalBtn" class="btn btn-primary">Cadastrar Usuário</button>
        </div>
        <br>
        <!-- BARRA DE BUSCA -->
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Buscar usuário...">
        </div>

        <table class="styled-table">
            <thead>
                <tr>
                    <th>Usuário</th>
                    <th>Nível</th>
                    <th>Turma</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                {% if usuarios %}
                {% for usuario in usuarios %}
                <tr>
                    <td class="cor-tx">{{ usuario[0] }}</td>
                    <td class="cor-tx">{{ usuario[2] }}</td>
                    <td class="cor-tx">{{ usuario[3] if usuario[3] else '-' }}</td>
                    <td class="actions">
                        <button class="btn btn-edit"
                            onclick="abrirModalEdicao('{{ usuario[0] }}','{{ usuario[2] }}','{{ usuario[3] if usuario[3] }}')">
                            Editar
                        </button>
                        <button class="btn btn-delete" onclick="confirmarDelecao('{{ usuario[0] }}')">
                            Deletar
                        </button>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="4">Nenhum usuário cadastrado</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </section>
</main>

<!-- MODAL DE CADASTRO -->
<div id="modalCadastro" class="modal">
    <div class="modal-content">
        <span id="closeModalBtn" class="close">&times;</span>
        <h2>Cadastrar Usuário</h2>
        <form method="post" action="/cadastrarUsuario" class="form-grid" id="formCadastro">
            <div class="form-group">
                <label for="pk_usuario">Usuário (login):</label>
                <input type="text" name="pk_usuario" id="pk_usuario" required>
            </div>

            <div class="form-group">
                <label for="senha">Senha:</label>
                <input type="password" name="senha" id="senha" required minlength="6">
            </div>

            <div class="form-group">
                <label for="nivel">Nível:</label>
                <select name="nivel" id="nivel" required onchange="toggleTurmaSelect('cadastro')">
                    <option value="">Selecione</option>
                    <option value="Administrador">Administrador</option>
                    <option value="AlunoMonitor">Aluno Monitor</option>
                </select>
            </div>

            <div class="form-group" id="turmaCadastro" style="display:none;">
                <label for="fk_nome_turma">Turma:</label>
                <select name="fk_nome_turma" id="fk_nome_turma">
                    <option value="">Selecione</option>
                    {% for turma in turmas %}
                    <option value="{{ turma['pk_nome_turma'] }}">{{ turma['pk_nome_turma'] }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Cadastrar</button>
            </div>
        </form>
    </div>
</div>

<!-- MODAL DE EDIÇÃO -->
<div id="modalEdicao" class="modal">
    <div class="modal-content">
        <span id="closeEditBtn" class="close">&times;</span>
        <h2>Editar Usuário</h2>
        <form id="formEdicao" method="post" class="form-grid">
            <div class="form-group">
                <label>Usuário (login):</label>
                <input type="text" name="pk_usuario" id="editUsuario" readonly>
            </div>

            <div class="form-group">
                <label>Nível:</label>
                <select name="nivel" id="editNivel" required onchange="toggleTurmaSelect('edicao')">
                    <option value="Administrador">Administrador</option>
                    <option value="AlunoMonitor">Aluno Monitor</option>
                </select>
            </div>

            <div class="form-group" id="turmaEdicao" style="display:none;">
                <label for="edit_fk_nome_turma">Turma:</label>
                <!-- IMPORTANT: name="fk_nome_turma" (mesmo nome que o backend espera) -->
                <select name="fk_nome_turma" id="edit_fk_nome_turma">
                    <option value="">Selecione</option>
                    {% for turma in turmas %}
                    <option value="{{ turma['pk_nome_turma'] }}">{{ turma['pk_nome_turma'] }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label>Nova senha (opcional):</label>
                <input type="password" name="senha" id="editSenha" placeholder="Digite uma nova senha">
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-edit">Salvar Alterações</button>
            </div>
        </form>
    </div>
</div>

<!-- MODAL DE CONFIRMAÇÃO -->
<div id="modalConfirmacao" class="modal">
    <div class="modal-content">
        <h3 id="textoConfirmacao"></h3>
        <div class="form-actions">
            <button id="btnCancelar" class="btn btn-primary">Cancelar</button>
            <a id="btnConfirmar" class="btn btn-delete">Confirmar</a>
        </div>
    </div>
</div>

<!-- MODAL DE ERRO -->
<div id="modalErro" class="modal">
    <div class="modal-content">
        <h3 id="textoErro" style="color: #b71c1c; margin-bottom: 12px;"></h3>
        <div class="form-actions">
            <button id="btnFecharErro" class="btn btn-primary">Fechar</button>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/cadastrarUsuario.js') }}"></script>

{% include 'footer.html' %}